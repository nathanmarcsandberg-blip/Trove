<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Assets – Trove</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="assets-wrap">
    <h1 style="text-align:center;margin-bottom:18px">trove assets</h1>
    <div class="asset-toolbar">
      <input id="assetSearch" class="asset-search" placeholder="Search assets…"/>
      <button class="pill active" data-cat="all">All</button>
      <button class="pill" data-cat="dividend_paying_stock">Dividend Stock</button>
      <button class="pill" data-cat="non_dividend_paying_stock">Non-Dividend Stock</button>
      <button class="pill" data-cat="cryptocurrency">Crypto</button>
    </div>
    <div class="asset-toolbar" style="justify-content:flex-start">
      <span id="pricesUpdatedTag" class="price-tag">Prices Last Updated: —</span>
      <button id="updateRatesBtn" class="btn">Update Rates</button>
    </div>
    <div id="assetsList" class="grid"></div>
  </main>
  <script src="assets-config.js" defer></script>
  <script src="data-prices.js" defer></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const listEl = document.getElementById('assetsList');
      const tagEl  = document.getElementById('pricesUpdatedTag');
      const btnEl  = document.getElementById('updateRatesBtn');
      const searchEl = document.getElementById('assetSearch');
      const pills = Array.from(document.querySelectorAll('.pill'));
      let currentCat='all', q='';
      function render(){
        const rows = window.TroveData?.getDisplayData?.() || [];
        const filtered = rows.filter(r=> (currentCat==='all'||r.class===currentCat) && (!q || r.name.toLowerCase().includes(q)));
        listEl.innerHTML = filtered.map(r=>{
          const priceStr = isFinite(r.price) ? ('$'+(+r.price).toFixed(2)) : '—';
          const y = (r.yield && r.yield!=='0' && r.yield!=='0%') ? (' • <span class="yield">'+r.yield+'</span>') : '';
          return `<div class="card"><div class="name">${r.name}</div><div class="meta">${priceStr}${y}</div><div style="font-size:.85rem;opacity:.7">${r.class.replaceAll('_',' ')}</div></div>`;
        }).join('');
      }
      searchEl.addEventListener('input', e=>{ q=e.target.value.trim().toLowerCase(); render(); });
      pills.forEach(p=>p.addEventListener('click', ()=>{ pills.forEach(x=>x.classList.remove('active')); p.classList.add('active'); currentCat=p.dataset.cat; render(); }));
      window.TroveData?.onChange(()=>{ tagEl.textContent='Prices Last Updated: '+window.TroveData.getLastUpdatedTag(); render(); });
      tagEl.textContent='Prices Last Updated: '+(window.TroveData?.getLastUpdatedTag?.()||'—'); render();
      btnEl.addEventListener('click', async ()=>{ btnEl.disabled=true; const prev=btnEl.textContent; btnEl.textContent='Updating…'; try{ await window.TroveData.refreshPrices(true);}catch(e){console.error(e);}finally{btnEl.disabled=false; btnEl.textContent=prev;} });
      window.TroveData?.refreshPrices(false).catch(console.warn);
    });
  </script>
</body>
</html>
